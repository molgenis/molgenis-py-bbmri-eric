# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

executors:
  my-executor:
    docker:
      - image: cimg/python:3.10
    working_directory: ~/repo

jobs:
  build_and_test:
    executor: my-executor
    steps:
      - checkout
      - run: pip install tox
      - run: pip install pre-commit
      - run: pre-commit install
      - run: tox
      - run: pre-commit run --all-files
        # Iets met sonar voor PR:
        # "sonar-scanner -Dsonar.github.oauth=${env.GITHUB_TOKEN} -Dsonar.pullrequest.base=${CHANGE_TARGET} -Dsonar.pullrequest.branch=${BRANCH_NAME} -Dsonar.pullrequest.key=${env.CHANGE_ID} -Dsonar.pullrequest.provider=GitHub -Dsonar.pullrequest.github.repository=molgenis/molgenis-py-bbmri-eric"
        # voor main:
        # "sonar-scanner"

  release2testpypi:
    executor: my-executor
    steps:
      - checkout
      - run: pip install tox
      - run: git remote set-url origin https://${GITHUB_TOKEN}@github.com/${REPOSITORY}.git
      - run: git checkout -f main
      - run: git fetch --tags
      # bump the version based on the last tag and create a new tag
      - run:
          command: |
            pip install bumpversion
            NEW_PACKAGE_VERSION=$(bash bump-version.sh)
            echo $NEW_PACKAGE_VERSION
      - run: git checkout .
      - run: # build and publish the release
          command: |
            tox -e build
            tox -e publish -- --repository testpypi --username ${TESTPYPI_USERNAME} --password ${TESTPYPI_TOKEN}"

          # push the new tag to molgenis/molgenis-py-bbmri-eric
      # - run: git push --tags origin main
  release2pypi:
    executor: my-executor
    steps:
      - checkout
      - run: pip install tox
      # do the actual release to PyPi
      # - run: tox -e publish -- --repository pypi --username ${PYPI_USERNAME} --password ${PYPI_PASSWORD}
      - run:
          name: message slack about release and updated demo server
          command: |
            curl -d "token=${SLACK_TOKEN}" \
            -d "text=molgenis-py-bbmri-eric ${NEW_PACKAGE_VERSION} is released. Check it out: https://pypi.org/project/molgenis-py-bbmri-eric/" \
            -d "channel=C01TN8FU480" \
            -X POST https://slack.com/api/chat.postMessage


workflows:
  build_pr_or_release:
    jobs:
      - build_and_test
      - release2testpypi:
          requires:
            - build_and_test
          filters:
            branches:
              only: circleci-project-setup
      - release2pypi?:
          type: approval
          requires:
            - build_and_test
            - release2testpypi
          filters:
            branches:
              only: circleci-project-setup
      - release2pypi:
          requires:
            - build_and_test
            - release2testpypi
          filters:
            branches:
              only: circleci-project-setup
